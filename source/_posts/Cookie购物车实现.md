---
title: Cookie购物车实现
date: 2017-06-08 23:08:39
comments: true
tags:
	 - Cookie
---

#### Cookie实现购物车

今天在PC端简单的实现了通过Cookie在未登录的情况下向购物车添加商品，并且在用户登陆后自动同步购物车商品到持久层代码逻辑。

1. 目前主流的电商平台：淘宝、天猫不支持未登录状态向购物车添加商品；京东是支持在未登录状态下向购物车添加商品的，并且能够进行较长时间的保存，重新打开浏览器后购物车商品依旧保存。
2. 但是网上有人说PC京东购物车即使在登陆后过一段时间依旧会丢掉，我感觉是不是即使登录后京东也没有将购物车数据保存到持久层，这个待验证。

#### 具体逻辑

1. 首先要将商品详情页添加购物车的按钮去除登录校验。
2. 我们平台是多二级域名的，不同二级域名对应不同的店铺，不同的店铺要求购物车不互通，登录状态下是添加购物车是将商品绑定到店铺和用户；而在未登录状态下，首次添加商品在服务端首次访问时生成相应的Cookie，以后每次获取对应Cookie，并且首次生成Cookie时通过UUID生成唯一的ID放在Cookie中，将商品绑定到对应ID和店铺。
3. 商品详情页的路径同购物车的路径时不同的，如果不对Cookie的path属性进行设置，则无法在购物车页面获取相应的Cookie，这里直接将Cookie的path设置为根路径`/`。
4. 这里我们要将未登录的购物车的商品进行较长时间的保存，所以我们需要设置Cookie的失效时间，也就是maxAge属性，我这里将这个字段设置为`60*60*24*30`，maxAge的单位为秒，也就是Cookie的失效时间为1个月。
5. 前面我说过我们平台要求不同二级域名下的购物车不共享，也就是说不涉及跨域的问题，所以不需要设置Cookie的domain属性。
6. 由于我们平台主要做一些印刷类的商品，也就是说买家购买商品的同时很可能勾选较多的属性字段，并且上传制作的稿件，所以购物车的商品绑定的内容是较多的，有可能超过Cookie的大小限制，并且将较多的属性直接绑定的Cookie是不安全的，所以这里Cookie中只是简单保存了通过UUID生成的临时客户ID，其他信息通过临时客户ID缓存到redis中，并且设置相应key值的失效时间为1个月。
7. 添加购物车功能到这里也就基本完成了，我们还需要继续解决未登录修改购物车商品数量、删除商品的操作以及用户登录后将临时保存的购物车商品同步到当前登录用户，并保存到持久层以及清楚redis中的缓存数据。
8. 通常我们会在全局有一个展示当前购物车商品个数的组件，同样我们也需要修改该组件请求后台数据时，正确计算未登录状态下的临时购物车商品个数。

#### 总结
为什么使用Cookie而不是session，因为这里需要实现关闭浏览器后再次打开依旧可以看到之前添加到购物车的商品，而关闭浏览器后，之前浏览器创建的session虽然依旧存在于服务端，但是我们再次打开浏览器无法直接重新获取之前的session。虽然可以通过将sessionId保存到Cookie，并且设置Cookie的失效时间来实现，但是这里我们只是缓存一个临时的用户ID，其他数据都存在于redis，所以直接使用Cookie我认为是正确的。
